<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Versátil Sistemas – Loja</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f4f0;
  --card:#f6efe6;
  --text:#2e2b25;
  --muted:#6b6257;
  --brand:#b29463;
  --brand-strong:#9a7a45;
  --border:#e7dfd4;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,sans-serif}
.header{height:64px;background:#111;display:flex;align-items:center;justify-content:space-between;padding:0 24px;color:#fff}
.logo-img{height:42px;border-radius:8px}
.header-right{display:flex;align-items:center;gap:16px}
.header-link{color:#fff;text-decoration:none;font-weight:600;opacity:.9;cursor:pointer}
.header-link:hover{opacity:1;text-decoration:underline}
.cart-btn{position:relative;border:0;background:transparent;color:#fff;cursor:pointer;padding:6px}
.cart-btn svg{width:26px;height:26px}
.badge{position:absolute;top:-4px;right:-4px;background:#ffae00;color:#111;border-radius:999px;font-size:12px;font-weight:700;padding:3px 6px;min-width:20px;text-align:center}
.main{padding:32px 24px}
.container{max-width:1240px;margin:0 auto;background:#fff;border:1px solid var(--border);border-radius:16px;padding:28px}
.title{font-size:40px;text-align:center;color:var(--brand-strong);font-weight:800}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;display:flex;flex-direction:column;gap:12px}
.card h3{margin:0;font-size:20px}
.card p{margin:0;color:var(--muted)}
.price{color:var(--brand-strong);font-weight:800}
.stock{color:var(--muted);font-size:14px}
.actions{margin-top:auto;display:flex;gap:12px;align-items:center}
.qty{display:flex;align-items:center;border:1px solid var(--border);border-radius:10px}
.qty button{border:0;background:#fff;padding:6px 10px;cursor:pointer}
.qty input{width:40px;text-align:center;border:0;background:#fff;font-weight:600}
.add{margin-left:auto;background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
.cart-drawer{position:fixed;inset:0 0 0 auto;width:420px;background:#fff;border-left:1px solid var(--border);transform:translateX(100%);transition:.25s;z-index:50;display:flex;flex-direction:column}
.cart-drawer.open{transform:translateX(0)}
.cart-head{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border);background:#faf8f4}
.cart-list{flex:1;overflow:auto;padding:8px 12px}
.item{border-bottom:1px dashed var(--border);padding:12px 4px}
.name{font-weight:700}
.unit{font-size:13px;color:var(--muted)}
.cart-foot{border-top:1px solid var(--border);padding:12px 16px;display:flex;flex-direction:column;gap:10px}
.total{display:flex;justify-content:space-between;font-size:18px;font-weight:800}
.btn{padding:10px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
.primary{background:var(--brand);color:#fff}
</style>
</head>
<body>

<header class="header">
  <div class="header-left">
    <img src="imagens/logoversatil.png" alt="Logo Versátil" class="logo-img">
  </div>
  <div class="header-right">
    <button id="openCart" class="cart-btn">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2Zm10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2ZM7.16 14h9.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.37-.66-.11-1.48-.86-1.48H6.21L5.27 2H2v2h2l3.6 7.59-1.35 2.45C5.52 14.37 6 15 6.7 15H20v-2H7.42l.74-1.36Z"/></svg>
      <span id="cartCount" class="badge">0</span>
    </button>
    <a class="header-link" href="pedidos.html">Meus Pedidos</a>
    <span id="logoutBtn" class="header-link">Sair</span>
  </div>
</header>

<main class="main">
  <div class="container">
    <h1 class="title">Lista de Produtos</h1>
    <div id="grid" class="grid"></div>
  </div>
</main>

<div id="overlay" class="overlay"></div>
<aside id="drawer" class="cart-drawer">
  <div class="cart-head">
    <h4>Seu carrinho</h4>
    <button id="closeCart" class="close">×</button>
  </div>
  <div id="cartList" class="cart-list"></div>
  <div class="cart-foot">
    <div class="total"><span>Total</span><span id="cartTotal">R$ 0,00</span></div>
    <button id="finalizar" class="btn primary">Finalizar compra</button>
  </div>
</aside>

<script>
const grid=document.getElementById('grid')
const drawer=document.getElementById('drawer')
const overlay=document.getElementById('overlay')
const cartList=document.getElementById('cartList')
const cartTotal=document.getElementById('cartTotal')
const cartCount=document.getElementById('cartCount')
const openCartBtn=document.getElementById('openCart')
const closeCartBtn=document.getElementById('closeCart')
const finalizarBtn=document.getElementById('finalizar')
const logoutBtn=document.getElementById('logoutBtn')
logoutBtn.onclick=()=>{
  localStorage.clear()
  window.location.href="login.html"
}

let carrinhoId=localStorage.getItem("carrinhoId")||null
const clienteLogado=JSON.parse(localStorage.getItem("cliente"))

function money(n){return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}

async function initCarrinho(){
  if(carrinhoId){await carregarCarrinho();return}
  const resp=await fetch("http://localhost:3000/carrinhos",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({idCliente:clienteLogado.idCliente})
  })
  const data=await resp.json()
  carrinhoId=data.carrinho.idCarrinho
  localStorage.setItem("carrinhoId",carrinhoId)
}

async function carregarProdutos(){
  const resp=await fetch("http://localhost:3000/produtos")
  const produtos=await resp.json()
  grid.innerHTML=''
  produtos.forEach(p=>{
    const card=document.createElement('div')
    card.className='card'
    card.innerHTML=`
      <h3>${p.nomeProd}</h3>
      <p>${p.descricao}</p>
      <div class="price">R$ ${p.precoUnitario.toFixed(2)}</div>
      <div class="stock">Estoque: ${p.quantidadeEstoque} unidades</div>
      <div class="actions">
        <div class="qty">
          <button data-minus>−</button>
          <input type="text" value="1">
          <button data-plus>+</button>
        </div>
        <button class="add">Adicionar</button>
      </div>
    `
    const input=card.querySelector('input')
    card.querySelector('[data-minus]').onclick=()=>input.value=Math.max(1,parseInt(input.value)-1)
    card.querySelector('[data-plus]').onclick=()=>input.value=parseInt(input.value)+1
    card.querySelector('.add').onclick=()=>adicionarCarrinho(p.idProd,parseInt(input.value))
    grid.appendChild(card)
  })
}

async function adicionarCarrinho(idProduto,quantidade){
  const resp=await fetch("http://localhost:3000/itensCarrinho",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({idCarrinho:carrinhoId,idProduto,quantidade})
  })
  if(resp.ok){carregarCarrinho()}else{alert("Erro ao adicionar")}
}

async function carregarCarrinho(){
  if(!carrinhoId)return
  const resp=await fetch(`http://localhost:3000/carrinhos/${carrinhoId}`)
  const carrinho=await resp.json()
  cartList.innerHTML=''
  let total=0
  carrinho.itensCarrinho.forEach(item=>{
    total+=item.precoUnitario*item.quantidade
    cartList.innerHTML+=`
      <div class="item">
        <div class="info">
          <div class="name">${item.produto.nomeProd}</div>
          <div class="unit">${item.quantidade} x ${money(item.precoUnitario)}</div>
        </div>
      </div>
    `
  })
  cartTotal.textContent=money(total)
  cartCount.textContent=carrinho.itensCarrinho.length
}

async function finalizarCompra(){
  const resp=await fetch(`http://localhost:3000/carrinhos/${carrinhoId}`)
  const carrinho=await resp.json()
  if(!carrinho.itensCarrinho.length){alert("Carrinho vazio");return}
  
  const itens=carrinho.itensCarrinho.map(i=>({
    idProduto:i.produto.idProd,
    quantidade:i.quantidade,
    precoUnitario:i.precoUnitario
  }))

  await fetch("http://localhost:3000/pedidos",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({idCliente:clienteLogado.idCliente,itens})
  })

  // limpar carrinho local
  localStorage.removeItem("carrinhoId")
  alert("Pedido finalizado!")
  window.location.href="pedidos.html"
}

function setOpen(v){drawer.classList.toggle('open',v);overlay?.classList.toggle('open',v)}

openCartBtn.onclick=()=>setOpen(true)
closeCartBtn.onclick=()=>setOpen(false)
finalizarBtn.onclick=()=>finalizarCompra()

initCarrinho().then(()=>{carregarProdutos();carregarCarrinho()})
</script>
</body>
</html>
